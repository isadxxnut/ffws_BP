<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ban/Pick - Display</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  /* Base styles for vMix/OBS overlay */
  html {
    /* Base font size scales with viewport width, based on a 1920px design. */
    font-size: calc(100vw / 1920 * 10px);
  }

  body {
    font-family: 'GFF Latin', sans-serif;
    background-image: url('https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/FFWSSEAFALL/BP_BO3.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color: #e0e0e0;
    margin: 0;
    padding: 0;
    overflow: hidden; /* Prevent any scrolling */
    width: 100vw;
    height: 100vh;
    box-sizing: border-box;
    position: relative;
  }

  /* =========================================================================
  === ADJUSTABLE POSITIONS, SIZES, AND COLORS ===
  คุณสามารถปรับตำแหน่ง ขนาด และสีของทุกองค์ประกอบได้ที่นี่
  =========================================================================
  */

  /* --- LABELS & TIMERS --- */
  #timer {
    position: absolute;
    top: 56.5rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 5rem;
    font-weight: 900;
    color: #ffffff;
    text-shadow: 0 0 1.5rem rgba(0,0,0,0.7);
  }
  
  #actionLabel {
    position: absolute;
    top: 61.2rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 3rem; 
    font-weight: 700;
    text-transform: uppercase;
    text-shadow: 0 0 1.5rem rgba(0,0,0,0.7);
  }

  /* Label Colors */
  #actionLabel.label-pick { color: #6bffb8; }
  #actionLabel.label-ban { color: #ff6b6b; }
  #actionLabel.label-select-player { color: #aaffaa; }
  #actionLabel.label-final {
    color: #ffffff;
    font-size: 2.5rem; /* Example: Can be adjusted */
  }

  .reserve-display {
    position: absolute;
    top: 63.8rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    justify-content: center;
    align-items: center;
    width: 25rem;
    gap: 2rem; /* Adjustable space between reserve times */
    text-shadow: 0 0 1.5rem rgba(0,0,0,0.7);
  }
  
  #reserveA, #reserveB, .reserve-label {
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
  }
  
  .reserve-label {
      font-size: 1.8rem;
      font-weight: 600;
  }

  /* --- CHARACTER & PLAYER ELEMENTS --- */
  .slot-effect, .slot-image-container, .char-name, .player-name {
    position: absolute;
    transition: all 0.3s ease;
  }

  .slot-image-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .slot-effect.active {
    border-color: rgba(255, 215, 0, 0.8); /* Gold color */
    animation: lightning-flicker 1.5s infinite;
  }
  
  /* Grayscale for confirmed BAN slots */
  #A0-img.confirmed img,
  #B0-img.confirmed img {
    filter: grayscale(100%);
  }


  /* BAN SLOTS */
  #A0-effect { top: 50.1rem; left: 1.49rem; width: 8.7rem; height: 15.88rem; }
  #A0-img { top: 51.2rem; left: 1.5rem; width: 9rem; height: 13.5rem; }
  #A0-char-name { top: 63rem; left: -1.5rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }

  #B0-effect { top: 50.1rem; right: 1.49rem; width: 8.7rem; height: 15.88rem; }
  #B0-img { top: 51.2rem; right: 1.5rem; width: 9rem; height: 13.5rem; }
  #B0-char-name { top: 63rem; right: -1.5rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  
  /* TEAM A PICK SLOTS */
  #A1-effect { bottom: 1rem; left: 11rem; width: 8.7rem; height: 15.88rem; }
  #A1-img { bottom: 2.8rem; left: 11rem; width: 9rem; height: 13.5rem; }
  #A1-char-name { bottom: 2.3rem; left: 8rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #A1-player-name { bottom: 1.3rem; left: 11.5rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  #A2-effect { bottom: 1rem; left: 20.7rem; width: 8.7rem; height: 15.88rem; }
  #A2-img { bottom: 2.8rem; left: 20.7rem; width: 9rem; height: 13.5rem; }
  #A2-char-name { bottom: 2.3rem; left: 17.7rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #A2-player-name { bottom: 1.3rem; left: 21rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  #A3-effect { bottom: 1rem; left: 30.1rem; width: 8.7rem; height: 15.88rem; }
  #A3-img { bottom: 2.8rem; left: 30.1rem; width: 9rem; height: 13.5rem; }
  #A3-char-name { bottom: 2.3rem; left: 27.1rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #A3-player-name { bottom: 1.3rem; left: 30.6rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  #A4-effect { bottom: 1rem; left: 39.8rem; width: 8.7rem; height: 15.88rem; }
  #A4-img { bottom: 2.8rem; left: 39.8rem; width: 9rem; height: 13.5rem; }
  #A4-char-name { bottom: 2.3rem; left: 36.8rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #A4-player-name { bottom: 1.3rem; left: 40.2rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  /* TEAM B PICK SLOTS */
  #B1-effect { bottom: 1rem; right: 11rem; width: 8.7rem; height: 15.88rem; }
  #B1-img { bottom: 2.8rem; right: 11rem; width: 9rem; height: 13.5rem; }
  #B1-char-name { bottom: 2.3rem; right: 8rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #B1-player-name { bottom: 1.3rem; right: 11.5rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  #B2-effect { bottom: 1rem; right: 20.7rem; width: 8.7rem; height: 15.88rem; }
  #B2-img { bottom: 2.8rem; right: 20.7rem; width: 9rem; height: 13.5rem; }
  #B2-char-name { bottom: 2.3rem; right: 17.7rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #B2-player-name { bottom: 1.3rem; right: 21.1rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  #B3-effect { bottom: 1rem; right: 30.1rem; width: 8.7rem; height: 15.88rem; }
  #B3-img { bottom: 2.8rem; right: 30.1rem; width: 9rem; height: 13.5rem; }
  #B3-char-name { bottom: 2.3rem; right: 27.1rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #B3-player-name { bottom: 1.3rem; right: 30.7rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  #B4-effect { bottom: 1rem; right: 39.8rem; width: 8.7rem; height: 15.88rem; }
  #B4-img { bottom: 2.8rem; right: 39.8rem; width: 9rem; height: 13.5rem; }
  #B4-char-name { bottom: 2.3rem; right: 36.8rem; width: 15rem; font-size: 1.8rem; color: #ffffff; }
  #B4-player-name { bottom: 1.3rem; right: 40.3rem; width: 15rem; font-size: 0.8rem; color: #ffc107; }

  /* =========================================================================
  === CORE STYLES (Should not need frequent changes) ===
  =========================================================================
  */

  .char-name, .player-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 0 0.5rem rgba(0,0,0,0.8);
    z-index: 7;
  }

  /* Align Character names to the center */
  .char-name {
    text-align: center;
  }

  /* Align Team A player names to the left */
  [id^="A"][id$="-player-name"] {
    text-align: left;
  }

  /* Align Team B player names to the right */
  [id^="B"][id$="-player-name"] {
    text-align: right;
  }
  
  .slot-effect {
    border: 4px solid transparent;
    pointer-events: none;
    z-index: 5;
    border-radius: 1rem; /* Rounded corners for the effect */
  }

  .slot-image-container {
    overflow: hidden;
    z-index: 6;
  }

  @keyframes lightning-flicker {
    0%, 100% { 
      border-color: rgba(255, 215, 0, 0.8); 
      box-shadow: 0 0 1.5rem rgba(255, 215, 0, 0.9); 
    }
    50% { 
      border-color: rgba(255, 225, 100, 1); 
      box-shadow: 0 0 2.5rem rgba(255, 225, 100, 1); 
    }
    52% { 
      border-color: rgba(255, 215, 0, 0.7); 
      box-shadow: 0 0 1rem rgba(255, 215, 0, 0.8); 
    }
    55% { 
      border-color: rgba(255, 225, 100, 1); 
      box-shadow: 0 0 2rem rgba(255, 225, 100, 1); 
    }
  }

</style>
</head>
<body>

    <!-- Timer Elements -->
    <div id="timer">30</div>
    <div id="actionLabel"></div>
    <div class="reserve-display">
      <span id="reserveA">60</span>
      <span class="reserve-label">Reserve</span>
      <span id="reserveB">60</span>
    </div>
    
    <!-- Element Containers -->
    <div id="element-container">
        <!-- This will be populated by JS -->
    </div>


<script>
// Firebase configuration (Same as your admin panel)
if (!firebase.apps.length) {
const firebaseConfig = {
  apiKey: "AIzaSyB9EkrAmtLoF_i7fPDezhc2DjJJzxjPOZs",
  authDomain: "ffws-sea-fall-ban-pick.firebaseapp.com",
  databaseURL: "https://ffws-sea-fall-ban-pick-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ffws-sea-fall-ban-pick",
  storageBucket: "ffws-sea-fall-ban-pick.firebasestorage.app",
  messagingSenderId: "218652907770",
  appId: "1:218652907770:web:43fc0b73871e9335749143",
  measurementId: "G-F3CN9C599H"
};

    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// Firebase references
const roomRef = db.ref("drafts/room1");
const gameStateRef = roomRef.child("gameState");
const slotAssignmentsRef = roomRef.child("slotAssignments");
const liveSelectionsRef = roomRef.child("liveSelections");

// The sequence of picks and bans
const steps = [
    { team: 'A', slots: ['A0'] },
    { team: 'B', slots: ['B0'] },
    { team: 'A', slots: ['A1'] },
    { team: 'B', slots: ['B2', 'B1'] },
    { team: 'A', slots: ['A2', 'A3'] },
    { team: 'B', slots: ['B3', 'B4'] },
    { team: 'A', slots: ['A4'] }
];

const allSlotIds = ["A0", "A1", "A2", "A3", "A4", "B0", "B1", "B2", "B3", "B4"];

// Global state variables
let currentStep = 0;
let timer = null;
let timeLeft = 30;
let reserveA = 60;
let reserveB = 60;
let isStarted = false;
let isPreparing = false;
let assignmentsConfirmed = false;
let countdownStartTime = 0;

function createElements() {
    const container = document.getElementById('element-container');
    container.innerHTML = ''; // Clear previous elements
    allSlotIds.forEach(id => {
        // Effect container
        const effectDiv = document.createElement('div');
        effectDiv.className = 'slot-effect';
        effectDiv.id = `${id}-effect`;
        container.appendChild(effectDiv);

        // Image container
        const imgDiv = document.createElement('div');
        imgDiv.className = 'slot-image-container';
        imgDiv.id = `${id}-img`;
        container.appendChild(imgDiv);

        // Char name
        const charNameDiv = document.createElement('div');
        charNameDiv.className = 'char-name';
        charNameDiv.id = `${id}-char-name`;
        container.appendChild(charNameDiv);

        // Player name (only for pick slots)
        if (!id.endsWith('0')) {
            const playerNameDiv = document.createElement('div');
            playerNameDiv.className = 'player-name';
            playerNameDiv.id = `${id}-player-name`;
            container.appendChild(playerNameDiv);
        }
    });
}

function highlightSlot() {
    document.querySelectorAll(".slot-effect").forEach(el => el.classList.remove("active"));
    const actionLabelEl = document.getElementById("actionLabel");
    actionLabelEl.className = ''; // Reset classes

    const step = steps[currentStep];
    if (!step) return;

    step.slots.forEach(id => {
        const slotEl = document.getElementById(`${id}-effect`);
        if (slotEl) slotEl.classList.add("active");
    });
    
    const slotID = step.slots[0];
    const isBan = slotID.endsWith("0");
    actionLabelEl.textContent = isBan ? "BAN" : "PICK";
    actionLabelEl.classList.add(isBan ? 'label-ban' : 'label-pick');
}

function updateTimerDisplay() {
    document.getElementById("timer").textContent = timeLeft;
    document.getElementById("reserveA").textContent = reserveA;
    document.getElementById("reserveB").textContent = reserveB;
}

function startCountdown() {
    clearInterval(timer);
    countdownStartTime = Date.now();
    let initialTimeLeft = timeLeft;
    let initialReserveA = reserveA;
    let initialReserveB = reserveB;
    const team = steps[currentStep]?.team;

    timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - countdownStartTime) / 1000);
        let newTimeLeft = initialTimeLeft - elapsed;

        if (isPreparing) {
            timeLeft = newTimeLeft > 0 ? newTimeLeft : 0;
            updateTimerDisplay();
            if (timeLeft <= 0) clearInterval(timer);
            return;
        }

        if (newTimeLeft >= 0) {
            timeLeft = newTimeLeft;
        } else {
            timeLeft = 0;
            const reserveElapsed = -newTimeLeft;
            if (team === 'A') {
                reserveA = Math.max(0, initialReserveA - reserveElapsed);
            } else if (team === 'B') {
                reserveB = Math.max(0, initialReserveB - reserveElapsed);
            }
        }
        
        updateTimerDisplay();

        if (timeLeft <= 0 && ((team === 'A' && reserveA <= 0) || (team === 'B' && reserveB <= 0))) {
            clearInterval(timer);
        }
    }, 1000);
}

function clearAllSlots() {
    allSlotIds.forEach(id => {
        const effectEl = document.getElementById(`${id}-effect`);
        const imgEl = document.getElementById(`${id}-img`);
        const charNameEl = document.getElementById(`${id}-char-name`);
        const playerNameEl = document.getElementById(`${id}-player-name`);

        if(effectEl) effectEl.classList.remove("active");
        if(imgEl) {
            imgEl.innerHTML = '';
            imgEl.classList.remove("confirmed");
        }
        if(charNameEl) charNameEl.textContent = '';
        if(playerNameEl) playerNameEl.textContent = '';
    });
}

// Listener for game state changes from Firebase (Confirmed Picks)
gameStateRef.on("value", snapshot => {
    const gameState = snapshot.val();
    const actionLabelElement = document.getElementById("actionLabel");
    const timerElement = document.getElementById("timer");
    const reserveElement = document.querySelector(".reserve-display");

    actionLabelElement.className = ''; // Reset classes

    if (!gameState || (!gameState.isStarted && !gameState.isPreparing && !gameState.assignmentsConfirmed)) {
        isStarted = false;
        isPreparing = false;
        assignmentsConfirmed = false;
        currentStep = 0;
        timeLeft = 30;
        reserveA = 60;
        reserveB = 60;
        updateTimerDisplay();
        if (timer) clearInterval(timer);
        actionLabelElement.textContent = "";
        timerElement.style.display = 'block';
        reserveElement.style.display = 'flex';
        timerElement.textContent = "30";
        clearAllSlots();
        return;
    }

    isStarted = gameState.isStarted;
    isPreparing = gameState.isPreparing;
    assignmentsConfirmed = gameState.assignmentsConfirmed;
    currentStep = gameState.currentStep;
    timeLeft = gameState.timeLeft;
    reserveA = gameState.reserveA;
    reserveB = gameState.reserveB;
    updateTimerDisplay();
    if (timer) clearInterval(timer);

    // Clear confirmed status before redrawing
    document.querySelectorAll(".slot-image-container").forEach(el => el.classList.remove("confirmed"));

    if (gameState.slots) {
        for (const slotId in gameState.slots) {
            const char = gameState.slots[slotId];
            const imgEl = document.getElementById(`${slotId}-img`);
            const charNameEl = document.getElementById(`${slotId}-char-name`);
            if (char && char.name && char.url && imgEl && charNameEl) {
                imgEl.innerHTML = `<img src="${char.url}" alt="${char.name}">`;
                charNameEl.textContent = char.name;
                imgEl.classList.add("confirmed");
            }
        }
    }
    
    timerElement.style.display = 'block';
    reserveElement.style.display = 'flex';
    
    if (isStarted && steps[currentStep]) { 
        highlightSlot();
        startCountdown();
    } else if (isPreparing) {
        actionLabelElement.textContent = "SELECT PLAYER";
        actionLabelElement.classList.add('label-select-player');
        document.querySelectorAll(".slot-effect").forEach(el => el.classList.remove("active"));
        startCountdown();
    } else if (assignmentsConfirmed) {
        actionLabelElement.textContent = "Starting soon"; 
        actionLabelElement.classList.add('label-final');
        timerElement.style.display = 'none';
        reserveElement.style.display = 'none';
        document.querySelectorAll(".slot-effect").forEach(el => el.classList.remove("active"));
    }
});

// Listener for player assignments
slotAssignmentsRef.on("value", snapshot => {
    const assignments = snapshot.val() || {};
     // Clear all player names before updating
    document.querySelectorAll(".player-name").forEach(el => el.textContent = "");

    for(const slotId in assignments) {
        const playerName = assignments[slotId];
        const playerNameEl = document.getElementById(`${slotId}-player-name`);
        if(playerNameEl) {
            playerNameEl.textContent = playerName;
        }
    }
});

// Listener for live selections (Real-time display)
liveSelectionsRef.on("value", snapshot => {
    if (!isStarted) return;
    const selections = snapshot.val() || {};
    const step = steps[currentStep];
    if (!step) return;

    // Clear previous live selections in the current active slots
    step.slots.forEach(slotId => {
        const imgEl = document.getElementById(`${slotId}-img`);
        const charNameEl = document.getElementById(`${slotId}-char-name`);
        // Only clear if it's not already confirmed
        if (imgEl && !imgEl.classList.contains('confirmed')) {
            imgEl.innerHTML = '';
        }
        if (charNameEl && !document.getElementById(`${slotId}-img`).classList.contains('confirmed')) {
            charNameEl.textContent = '';
        }
    });

    // Display new live selections
    for (const slotId in selections) {
        // Ensure we only update the slots for the current step
        if (step.slots.includes(slotId)) {
            const char = selections[slotId];
            const imgEl = document.getElementById(`${slotId}-img`);
            const charNameEl = document.getElementById(`${slotId}-char-name`);
            if (char && char.name && char.url && imgEl && charNameEl) {
                imgEl.innerHTML = `<img src="${char.url}" alt="${char.name}">`;
                charNameEl.textContent = char.name;
            }
        }
    }
});

// Initial setup
window.onload = createElements;
</script>
</body>
</html>
