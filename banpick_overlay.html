<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ban/Pick - Display</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  html { font-size: calc(100vw / 1920 * 10px); }
  body {
    font-family: 'GFF Latin', sans-serif;
    background-color: transparent;
    color: #e0e0e0;
    margin: 0;
    padding: 0;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    box-sizing: border-box;
    position: relative;
  }
  #background-container {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-image: url('https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/FFWSSEAFALL/BP_BO3.png');
    background-size: cover; background-position: center; background-repeat: no-repeat;
    z-index: 1;
  }

  /* =========================================================================
  === CORE BAN/PICK STYLES (ส่วนเดิม) ===
  ========================================================================= */
  #timer {
    position: absolute; top: 56.35rem; left: 50%; transform: translateX(-50%);
    font-size: 5rem; font-weight: 900; color: #ffffff; text-shadow: 0 0 1.5rem rgba(0,0,0,0.7); z-index: 10;
  }
  .arrow-container { position: absolute; display: none; z-index: 10; animation: flashing 1s infinite; }
  .turn-arrow { width: 100%; height: 100%; }
  #arrow-container-A { top: 58.5rem; left: 46.5%; width: 5rem; height: 5rem; transform: translateX(-100%); }
  #arrow-container-B { top: 58.5rem; right: 46.5%; width: 5rem; height: 5rem; transform: translateX(100%); }
  #turnArrowA { clip-path: polygon(0 50%, 75% 0, 75% 100%); }
  #turnArrowB { clip-path: polygon(100% 50%, 25% 0, 25% 100%); }
  .arrow-ban { background-color: #ff3b3b; }
  .arrow-pick { background-color: #6bffb8; }
  #actionLabel {
    position: absolute; top: 61.9rem; left: 50%; transform: translateX(-50%);
    font-size: 2.5rem; font-weight: 700; text-transform: uppercase; text-shadow: 0 0 1.5rem rgba(0,0,0,0.7); z-index: 10;
  }
  #actionLabel.label-pick { color: #6bffb8; }
  #actionLabel.label-ban { color: #ff6b6b; }
  #actionLabel.label-select-player { color: #aaffaa; }
  #actionLabel.label-final { color: #ffffff; font-size: 2.5rem; }
  .reserve-display {
    position: absolute; top: 63.8rem; left: 50%; transform: translateX(-50%);
    display: flex; justify-content: center; align-items: center; width: 25rem; gap: 2rem; text-shadow: 0 0 1.5rem rgba(0,0,0,0.7); z-index: 10;
  }
  #reserveA, #reserveB, .reserve-label { font-size: 2.5rem; font-weight: 700; color: #fff; }
  #reserveA, #reserveB { min-width: 3.5rem; display: inline-block; }
  #reserveA { text-align: right; }
  #reserveB { text-align: left; }
  .reserve-label { font-size: 1.4rem; font-weight: 600; }
  .slot-effect, .slot-image-container, .char-name, .player-name { position: absolute; transition: all 0.3s ease; }
  .player-name { opacity: 0; transition: opacity 0.5s ease 0.3s; }
  .player-name.visible { opacity: 1; }
  .slot-image-container img { width: 100%; height: 100%; object-fit: contain; }
  .slot-effect.active { border-color: rgba(255, 215, 0, 0.8); animation: lightning-flicker 1.5s infinite; }
  #A0-img.confirmed img, #B0-img.confirmed img { filter: grayscale(100%); }
  #A0-effect { top: 50.1rem; left: 1.49rem; width: 8.7rem; height: 15.88rem; }
  #A0-img { top: 51.2rem; left: 1.5rem; width: 9rem; height: 13.5rem; }
  #A0-char-name { top: 63rem; left: -1.5rem; width: 15rem; font-size: 1.8rem; color: #ffffff; font-weight: 700;}
  #B0-effect { top: 50.1rem; right: 1.49rem; width: 8.7rem; height: 15.88rem; }
  #B0-img { top: 51.2rem; right: 1.5rem; width: 9rem; height: 13.5rem; }
  #B0-char-name { top: 63rem; right: -1.5rem; width: 15rem; font-size: 1.8rem; color: #ffffff; font-weight: 700;}
  #A1-effect { bottom: 1rem; left: 11rem; width: 8.7rem; height: 15.88rem; }
  #A1-img { bottom: 2.8rem; left: 11rem; width: 9rem; height: 13.5rem; }
  #A1-char-name { bottom: 2.3rem; left: 8rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #A1-player-name { bottom: 1.3rem; left: 11.5rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  #A2-effect { bottom: 1rem; left: 20.7rem; width: 8.7rem; height: 15.88rem; }
  #A2-img { bottom: 2.8rem; left: 20.7rem; width: 9rem; height: 13.5rem; }
  #A2-char-name { bottom: 2.3rem; left: 17.7rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #A2-player-name { bottom: 1.3rem; left: 21rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  #A3-effect { bottom: 1rem; left: 30.1rem; width: 8.7rem; height: 15.88rem; }
  #A3-img { bottom: 2.8rem; left: 30.1rem; width: 9rem; height: 13.5rem; }
  #A3-char-name { bottom: 2.3rem; left: 27.1rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #A3-player-name { bottom: 1.3rem; left: 30.6rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  #A4-effect { bottom: 1rem; left: 39.8rem; width: 8.7rem; height: 15.88rem; }
  #A4-img { bottom: 2.8rem; left: 39.8rem; width: 9rem; height: 13.5rem; }
  #A4-char-name { bottom: 2.3rem; left: 36.8rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #A4-player-name { bottom: 1.3rem; left: 40.2rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  #B1-effect { bottom: 1rem; right: 11rem; width: 8.7rem; height: 15.88rem; }
  #B1-img { bottom: 2.8rem; right: 11rem; width: 9rem; height: 13.5rem; }
  #B1-char-name { bottom: 2.3rem; right: 8rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #B1-player-name { bottom: 1.3rem; right: 11.5rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  #B2-effect { bottom: 1rem; right: 20.7rem; width: 8.7rem; height: 15.88rem; }
  #B2-img { bottom: 2.8rem; right: 20.7rem; width: 9rem; height: 13.5rem; }
  #B2-char-name { bottom: 2.3rem; right: 17.7rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #B2-player-name { bottom: 1.3rem; right: 21.1rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  #B3-effect { bottom: 1rem; right: 30.1rem; width: 8.7rem; height: 15.88rem; }
  #B3-img { bottom: 2.8rem; right: 30.1rem; width: 9rem; height: 13.5rem; }
  #B3-char-name { bottom: 2.3rem; right: 27.1rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #B3-player-name { bottom: 1.3rem; right: 30.7rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  #B4-effect { bottom: 1rem; right: 39.8rem; width: 8.7rem; height: 15.88rem; }
  #B4-img { bottom: 2.8rem; right: 39.8rem; width: 9rem; height: 13.5rem; }
  #B4-char-name { bottom: 2.3rem; right: 36.8rem; width: 15rem; font-size: 1.8rem; color: #212121; font-weight: 700;}
  #B4-player-name { bottom: 1.3rem; right: 40.3rem; width: 15rem; font-size: 0.8rem; color: #ffc107; font-weight: 400;}
  .char-name, .player-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 0.1rem rgba(0,0,0,0.8); z-index: 7; }
  .char-name { text-align: center; }
  [id^="A"][id$="-player-name"] { text-align: left; }
  [id^="B"][id$="-player-name"] { text-align: right; }
  .slot-effect { border: 4px solid transparent; pointer-events: none; z-index: 5; border-radius: 1rem; }
  .slot-image-container { overflow: hidden; z-index: 6; }
  @keyframes lightning-flicker { 0%, 100% { border-color: rgba(255, 215, 0, 0.8); box-shadow: 0 0 1.5rem rgba(255, 215, 0, 0.9); } 50% { border-color: rgba(255, 225, 100, 1); box-shadow: 0 0 2.5rem rgba(255, 225, 100, 1); } 52% { border-color: rgba(255, 215, 0, 0.7); box-shadow: 0 0 1rem rgba(255, 215, 0, 0.8); } 55% { border-color: rgba(255, 225, 100, 1); box-shadow: 0 0 2rem rgba(255, 225, 100, 1); } }
  @keyframes flashing { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

  /* =========================================================================
  === NEW MATCH INFO STYLES ===
  ========================================================================= */
  .info-element {
    position: absolute;
    z-index: 20;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .info-element.visible {
    opacity: 1;
  }
  .info-element img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .player-role {
    opacity: 0; /* Roles are also hidden by default */
    transition: opacity 0.5s ease 0.3s;
  }
  .player-role.visible {
      opacity: 1;
  }

  /* --- ปรับตำแหน่งและขนาดข้อมูลการแข่งขันได้ที่นี่ --- */
#teamANameOverlay { top: 45rem; left: 25rem; width: 30rem; font-size: 3rem; color: white; text-align: left; font-weight: 800; }
#teamBNameOverlay { top: 45rem; right: 25rem; width: 30rem; font-size: 3rem; color: white; text-align: right; font-weight: 800; }
#teamAScoreOverlay { top: 44.5rem; left: 41rem; width: 10rem; font-size: 4rem; color: #212121; text-align: left; font-weight: 800; }
#teamBScoreOverlay { top: 44.5rem; right: 41rem; width: 10rem; font-size: 4rem; color: #212121; text-align: right; font-weight: 800; }
  #teamALogoOverlay { top: 42.9rem; left: 12.3rem; width: 4.5rem; height: 8rem; }
  #teamBLogoOverlay { top: 42.9rem; right: 12rem; width: 4.5rem; height: 8rem; }
  #teamAFlagOverlay { top: 45rem; left: 3rem; width: 4rem; height: 4rem; }
  #teamBFlagOverlay { top: 45rem; right: 3rem; width: 4rem; height: 4rem; }
  
#teamALogoOverlay img, #teamBLogoOverlay img {
  filter: drop-shadow(0px 4px 5px rgba(0, 0, 0, 0.7));
}

  /* Player Roles Positions */
  .player-role { position: absolute; width: 6rem; height: 2.5rem; }
  #A1-role { bottom: 14.5rem; left: 11.1rem; }
  #A2-role { bottom: 14.5rem; left: 20.7rem; }
  #A3-role { bottom: 14.5rem; left: 30.4rem; }
  #A4-role { bottom: 14.5rem; left: 39.7rem; }
  #B1-role { bottom: 14.5rem; right: 11.2rem; }
  #B2-role { bottom: 14.5rem; right: 20.7rem; }
  #B3-role { bottom: 14.5rem; right: 30.4rem; }
  #B4-role { bottom: 14.5rem; right: 39.8rem; }
  /* ------------------------------------------------ */

</style>
</head>
<body>
    <div id="background-container"></div>

    <!-- Timer & Core Elements -->
    <div id="timer">30</div>
    <div id="arrow-container-A" class="arrow-container"><div id="turnArrowA" class="turn-arrow"></div></div>
    <div id="arrow-container-B" class="arrow-container"><div id="turnArrowB" class="turn-arrow"></div></div>
    <div id="actionLabel"></div>
    <div class="reserve-display">
      <span id="reserveA">60</span>
      <span class="reserve-label">RESERVE</span>
      <span id="reserveB">60</span>
    </div>
    
    <!-- Ban/Pick Elements -->
    <div id="element-container"></div>

    <!-- NEW Match Info Elements -->
    <div id="match-info-container">
        <div id="teamANameOverlay" class="info-element"></div>
        <div id="teamBNameOverlay" class="info-element"></div>
        <div id="teamAScoreOverlay" class="info-element"></div>
        <div id="teamBScoreOverlay" class="info-element"></div>
        <div id="teamALogoOverlay" class="info-element"><img src=""></div>
        <div id="teamBLogoOverlay" class="info-element"><img src=""></div>
        <div id="teamAFlagOverlay" class="info-element"><img src=""></div>
        <div id="teamBFlagOverlay" class="info-element"><img src=""></div>

        <div id="A1-role" class="info-element player-role"><img src=""></div>
        <div id="A2-role" class="info-element player-role"><img src=""></div>
        <div id="A3-role" class="info-element player-role"><img src=""></div>
        <div id="A4-role" class="info-element player-role"><img src=""></div>
        <div id="B1-role" class="info-element player-role"><img src=""></div>
        <div id="B2-role" class="info-element player-role"><img src=""></div>
        <div id="B3-role" class="info-element player-role"><img src=""></div>
        <div id="B4-role" class="info-element player-role"><img src=""></div>
    </div>

<script>
// Firebase configuration
if (!firebase.apps.length) {
const firebaseConfig = {
  apiKey: "AIzaSyB9EkrAmtLoF_i7fPDezhc2DjJJzxjPOZs",
  authDomain: "ffws-sea-fall-ban-pick.firebaseapp.com",
  databaseURL: "https://ffws-sea-fall-ban-pick-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ffws-sea-fall-ban-pick",
  storageBucket: "ffws-sea-fall-ban-pick.firebasestorage.app",
  messagingSenderId: "218652907770",
  appId: "1:218652907770:web:43fc0b73871e9335749143",
  measurementId: "G-F3CN9C599H"
};
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// Firebase references
const roomRef = db.ref("drafts/room1");
const gameStateRef = roomRef.child("gameState");
const teamDataRef = roomRef.child("teamData");
const slotAssignmentsRef = roomRef.child("slotAssignments");
const liveSelectionsRef = roomRef.child("liveSelections");
const matchInfoRef = roomRef.child("matchInfo");
const firstBanRef = roomRef.child("firstBanTeam");

// --- START: โครงสร้างโค้ดที่แก้ไขแล้ว ---

// Global state variables and caches
let timer = null, countdownStartTime = 0;
const allSlotIds = ["A0", "A1", "A2", "A3", "A4", "B0", "B1", "B2", "B3", "B4"];
let steps = [];
let teamData = {};
let assignments = {};
let matchInfoData = {};
let cachedGameState = null;

// ฟังก์ชันสำหรับสร้างลำดับการ Ban/Pick แบบไดนามิก
function generateSteps(firstBanner) {
    const secondBanner = firstBanner === 'A' ? 'B' : 'A';
    return [
        { team: firstBanner, slots: [`${firstBanner}0`] },
        { team: secondBanner, slots: [`${secondBanner}0`] },
        { team: firstBanner, slots: [`${firstBanner}1`] },
        { team: secondBanner, slots: [`${secondBanner}2`, `${secondBanner}1`] },
        { team: firstBanner, slots: [`${firstBanner}2`, `${firstBanner}3`] },
        { team: secondBanner, slots: [`${secondBanner}3`, `${secondBanner}4`] },
        { team: firstBanner, slots: [`${firstBanner}4`] }
    ];
}

// Listener ที่ 1: คอยดึงข้อมูลทีมที่แบนก่อน และสร้าง steps ใหม่
firstBanRef.on("value", snapshot => {
    const firstBanTeam = snapshot.val() || 'A';
    steps = generateSteps(firstBanTeam);
    renderFullDisplay(); // เมื่อได้ steps แล้ว ให้สั่งแสดงผลใหม่
});

// Listener ที่ 2: คอยดึงข้อมูลสถานะเกม
gameStateRef.on("value", snapshot => {
    cachedGameState = snapshot.val();
    renderFullDisplay(); // เมื่อ gameState อัปเดต ให้สั่งแสดงผลใหม่
});

// --- END: โครงสร้างโค้ดที่แก้ไขแล้ว ---

function createElements() {
    const container = document.getElementById('element-container');
    container.innerHTML = '';
    allSlotIds.forEach(id => {
        const effectDiv = document.createElement('div'); effectDiv.className = 'slot-effect'; effectDiv.id = `${id}-effect`; container.appendChild(effectDiv);
        const imgDiv = document.createElement('div'); imgDiv.className = 'slot-image-container'; imgDiv.id = `${id}-img`; container.appendChild(imgDiv);
        const charNameDiv = document.createElement('div'); charNameDiv.className = 'char-name'; charNameDiv.id = `${id}-char-name`; container.appendChild(charNameDiv);
        if (!id.endsWith('0')) {
            const playerNameDiv = document.createElement('div'); playerNameDiv.className = 'player-name'; playerNameDiv.id = `${id}-player-name`; container.appendChild(playerNameDiv);
        }
    });
}

function highlightSlot(currentStep) {
    document.querySelectorAll(".slot-effect").forEach(el => el.classList.remove("active"));
    const actionLabelEl = document.getElementById("actionLabel");
    actionLabelEl.className = '';
    const step = steps[currentStep];
    if (!step) return;
    step.slots.forEach(id => {
        const slotEl = document.getElementById(`${id}-effect`);
        if (slotEl) slotEl.classList.add("active");
    });
    const isBan = step.slots[0].endsWith("0");
    actionLabelEl.textContent = isBan ? "BAN" : "PICK";
    actionLabelEl.classList.add(isBan ? 'label-ban' : 'label-pick');
}

function updateTimerDisplay(timeLeft, reserveA, reserveB) {
    document.getElementById("timer").textContent = timeLeft;
    document.getElementById("reserveA").textContent = reserveA;
    document.getElementById("reserveB").textContent = reserveB;
}

function startCountdown(timeLeft, reserveA, reserveB, isPreparing, currentStep) {
    clearInterval(timer);
    countdownStartTime = Date.now();
    let initialTimeLeft = timeLeft, initialReserveA = reserveA, initialReserveB = reserveB;
    const team = (steps[currentStep] || {}).team;
    timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - countdownStartTime) / 1000);
        let newTimeLeft = initialTimeLeft - elapsed;
        let currentReserveA = initialReserveA;
        let currentReserveB = initialReserveB;

        if (isPreparing) {
            timeLeft = newTimeLeft > 0 ? newTimeLeft : 0;
            if (timeLeft <= 0) clearInterval(timer);
        } else {
            if (newTimeLeft >= 0) {
                timeLeft = newTimeLeft;
            } else {
                timeLeft = 0;
                const reserveElapsed = -newTimeLeft;
                if (team === 'A') {
                    currentReserveA = Math.max(0, initialReserveA - reserveElapsed);
                } else if (team === 'B') {
                    currentReserveB = Math.max(0, initialReserveB - reserveElapsed);
                }
            }
        }
        updateTimerDisplay(timeLeft, currentReserveA, currentReserveB);
        if (timeLeft <= 0 && ((team === 'A' && currentReserveA <= 0) || (team === 'B' && currentReserveB <= 0))) {
            clearInterval(timer);
        }
    }, 1000);
}

function clearAllSlots() {
    allSlotIds.forEach(id => {
        const effectEl = document.getElementById(`${id}-effect`);
        const imgEl = document.getElementById(`${id}-img`);
        const charNameEl = document.getElementById(`${id}-char-name`);
        const playerNameEl = document.getElementById(`${id}-player-name`);
        if(effectEl) effectEl.classList.remove("active");
        if(imgEl) { imgEl.innerHTML = ''; imgEl.classList.remove("confirmed"); }
        if(charNameEl) charNameEl.textContent = '';
        if(playerNameEl) {
             playerNameEl.textContent = '';
             playerNameEl.classList.remove('visible');
        }
        const roleEl = document.getElementById(`${id}-role`);
        if(roleEl){
            roleEl.classList.remove('visible');
            roleEl.querySelector('img').src = '';
        }
    });
}

function updatePlayerDisplays(assignmentsConfirmed) {
    // ซ่อนทุกอย่างก่อนเริ่ม
    document.querySelectorAll(".player-name").forEach(el => el.classList.remove('visible'));
    document.querySelectorAll(".player-role").forEach(el => el.classList.remove('visible'));

    if (!assignmentsConfirmed) return;

    // สร้าง Map สำหรับหา role key จากชื่อผู้เล่น เพื่อประสิทธิภาพที่ดีขึ้น
    const playerToRoleKeyMap = {};
    (teamData.playersA || []).forEach((name, index) => { if (name) playerToRoleKeyMap[name] = `A_${index}`; });
    (teamData.playersB || []).forEach((name, index) => { if (name) playerToRoleKeyMap[name] = `B_${index}`; });
    
    // --- จุดที่แก้ไข ---
    // 1. เตรียม Element ที่จะแสดงผลทั้งหมดไว้ใน Array ก่อน
    const elementsToShow = [];

    for (const slotId in assignments) {
        const playerName = assignments[slotId];
        if (!playerName) continue;

        // 1.1 เปลี่ยนข้อมูล Text และ Image Source ให้เสร็จสิ้นก่อน
        const playerNameEl = document.getElementById(`${slotId}-player-name`);
        if (playerNameEl) {
            playerNameEl.textContent = playerName;
            elementsToShow.push(playerNameEl); // เพิ่ม Element เข้าไปใน Array
        }

        if (matchInfoData.showRoles) {
            const roleKey = playerToRoleKeyMap[playerName];
            const roleUrl = (matchInfoData.roles || {})[roleKey] || '';
            const roleEl = document.getElementById(`${slotId}-role`);
            if (roleEl) {
                roleEl.querySelector('img').src = roleUrl;
                if (roleUrl) { // จะแสดงผลก็ต่อเมื่อมี URL ของ role
                    elementsToShow.push(roleEl); // เพิ่ม Element เข้าไปใน Array
                }
            }
        }
    }

    // 2. ใช้ requestAnimationFrame เพื่อเพิ่มคลาส .visible ในเฟรมถัดไป
    // ทำให้เบราว์เซอร์มีเวลา 1 เฟรมในการประมวลผลการเปลี่ยนแปลงข้อมูลก่อนเริ่ม Animation
    requestAnimationFrame(() => {
        elementsToShow.forEach(el => {
            el.classList.add('visible');
        });
    });
}

teamDataRef.on("value", snapshot => {
    teamData = snapshot.val() || {};
    if (cachedGameState) {
      updatePlayerDisplays(cachedGameState.assignmentsConfirmed);
    }
});

slotAssignmentsRef.on("value", snapshot => {
    assignments = snapshot.val() || {};
    if (cachedGameState) {
      updatePlayerDisplays(cachedGameState.assignmentsConfirmed);
    }
});

liveSelectionsRef.on("value", snapshot => {
    if (!cachedGameState || !cachedGameState.isStarted || steps.length === 0) return;
    const selections = snapshot.val() || {};
    const step = steps[cachedGameState.currentStep];
    if (!step) return;

    step.slots.forEach(slotId => {
        const imgEl = document.getElementById(`${slotId}-img`);
        const charNameEl = document.getElementById(`${slotId}-char-name`);
        if (imgEl && !imgEl.classList.contains('confirmed')) imgEl.innerHTML = '';
        if (charNameEl && !document.getElementById(`${slotId}-img`).classList.contains('confirmed')) charNameEl.textContent = '';
    });

    for (const slotId in selections) {
        if (step.slots.includes(slotId)) {
            const char = selections[slotId];
            const imgEl = document.getElementById(`${slotId}-img`);
            const charNameEl = document.getElementById(`${slotId}-char-name`);
            if (char && char.name && char.url && imgEl && charNameEl) {
                imgEl.innerHTML = `<img src="${char.url}" alt="${char.name}">`;
                charNameEl.textContent = char.name;
            }
        }
    }
});

matchInfoRef.on("value", snapshot => {
    matchInfoData = snapshot.val() || {};
    
    document.getElementById('teamANameOverlay').textContent = matchInfoData.teamAName || '';
    document.getElementById('teamBNameOverlay').textContent = matchInfoData.teamBName || '';
    document.getElementById('teamAScoreOverlay').textContent = matchInfoData.teamAScore || 0;
    document.getElementById('teamBScoreOverlay').textContent = matchInfoData.teamBScore || 0;
    document.getElementById('teamALogoOverlay').querySelector('img').src = matchInfoData.teamALogoUrl || '';
    document.getElementById('teamBLogoOverlay').querySelector('img').src = matchInfoData.teamBLogoUrl || '';
    document.getElementById('teamAFlagOverlay').querySelector('img').src = matchInfoData.teamAFlagUrl || '';
    document.getElementById('teamBFlagOverlay').querySelector('img').src = matchInfoData.teamBFlagUrl || '';

    const mainInfoElements = document.querySelectorAll('#teamANameOverlay, #teamBNameOverlay, #teamAScoreOverlay, #teamBScoreOverlay, #teamALogoOverlay, #teamBLogoOverlay, #teamAFlagOverlay, #teamBFlagOverlay');
    if (matchInfoData.showInfo) {
        mainInfoElements.forEach(el => el.classList.add('visible'));
    } else {
        mainInfoElements.forEach(el => el.classList.remove('visible'));
    }

    if (cachedGameState) {
        updatePlayerDisplays(cachedGameState.assignmentsConfirmed);
    }
});

// <<< MAIN RENDER FUNCTION >>>
// ฟังก์ชันกลางที่จะถูกเรียกใช้ทุกครั้งที่ข้อมูลมีการเปลี่ยนแปลง
function renderFullDisplay() {
    // Guard Clause: จะไม่ทำงานจนกว่าข้อมูลที่จำเป็นจะมาครบ (ทั้ง gameState และ steps)
    if (!cachedGameState || steps.length === 0) {
        // ถ้ายังไม่พร้อม ให้แสดงสถานะเริ่มต้นไปก่อน
        clearAllSlots();
        updateTimerDisplay(30, 60, 60);
        document.getElementById("actionLabel").textContent = "";
        return;
    }

    const { isStarted, isPreparing, assignmentsConfirmed, currentStep, timeLeft, reserveA, reserveB } = cachedGameState;
    const actionLabelElement = document.getElementById("actionLabel");
    const timerElement = document.getElementById("timer");
    const reserveElement = document.querySelector(".reserve-display");
    const arrowA = document.getElementById('arrow-container-A'), arrowB = document.getElementById('arrow-container-B');
    const arrowDivA = document.getElementById('turnArrowA'), arrowDivB = document.getElementById('turnArrowB');

    actionLabelElement.className = '';
    arrowA.style.display = 'none'; arrowB.style.display = 'none';
    arrowDivA.className = 'turn-arrow'; arrowDivB.className = 'turn-arrow';

    if (!isStarted && !isPreparing && !assignmentsConfirmed) {
        if (timer) clearInterval(timer);
        actionLabelElement.textContent = "";
        timerElement.style.display = 'block';
        reserveElement.style.display = 'flex';
        clearAllSlots();
        updateTimerDisplay(30, 60, 60);
        return;
    }

    if (timer) clearInterval(timer);
    
    document.querySelectorAll(".slot-image-container").forEach(el => el.classList.remove("confirmed"));
    if (cachedGameState.slots) {
        for (const slotId in cachedGameState.slots) {
            const char = cachedGameState.slots[slotId];
            const imgEl = document.getElementById(`${slotId}-img`);
            const charNameEl = document.getElementById(`${slotId}-char-name`);
            if (char && char.name && char.url && imgEl && charNameEl) {
                imgEl.innerHTML = `<img src="${char.url}" alt="${char.name}">`;
                charNameEl.textContent = char.name;
                imgEl.classList.add("confirmed");
            }
        }
    }
    
    updatePlayerDisplays(assignmentsConfirmed);

    timerElement.style.display = 'block';
    reserveElement.style.display = 'flex';
    
    if (isStarted && steps[currentStep]) { 
        highlightSlot(currentStep);
        startCountdown(timeLeft, reserveA, reserveB, isPreparing, currentStep);
        const step = steps[currentStep];
        const isBan = step.slots[0].endsWith("0");
        const activeArrowContainer = step.team === 'A' ? arrowA : arrowB;
        const activeArrowDiv = step.team === 'A' ? arrowDivA : arrowDivB;
        activeArrowContainer.style.display = 'block';
        activeArrowDiv.classList.add(isBan ? 'arrow-ban' : 'arrow-pick');
    } else if (isPreparing) {
        actionLabelElement.textContent = "SELECT PLAYER";
        actionLabelElement.classList.add('label-select-player');
        document.querySelectorAll(".slot-effect").forEach(el => el.classList.remove("active"));
        reserveElement.style.display = 'none';
        startCountdown(timeLeft, reserveA, reserveB, isPreparing, currentStep);
    } else if (assignmentsConfirmed) {
        actionLabelElement.textContent = "Starting soon"; 
        actionLabelElement.classList.add('label-final');
        timerElement.style.display = 'none';
        reserveElement.style.display = 'none';
        document.querySelectorAll(".slot-effect").forEach(el => el.classList.remove("active"));
    }
    
    updateTimerDisplay(timeLeft, reserveA, reserveB);
}

// Initial setup
window.onload = createElements;
</script>
</body>
</html>

